<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è…è‡“å†…ç§‘ ç´¹ä»‹çŠ¶ä½œæˆãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    #chat {
      border: 1px solid #aaa;
      padding: 15px;
      height: 400px;
      overflow-y: scroll;
      white-space: pre-wrap;
      background: #fafafa;
    }
    .msg-user { color: blue; margin-bottom: 10px; }
    .msg-bot { color: black; margin-bottom: 10px; }
    #ocrResult {
      background: #f5f5f5;
      padding: 10px;
      white-space: pre-wrap;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h1>è…è‡“å†…ç§‘ ç´¹ä»‹çŠ¶ä½œæˆãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>

  <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="chat"></div>

  <br>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› -->
  <textarea id="userInput" rows="3" style="width:100%;"></textarea>
  <button onclick="sendMessage()">é€ä¿¡</button>

  <hr>

  <!-- éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°èªè­˜ï¼‰ -->
  <button onclick="startVoice()">ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹</button>
  <span id="voiceStatus"></span>

  <hr>

  <!-- OCRï¼ˆç”»åƒ â†’ ãƒ†ã‚­ã‚¹ãƒˆï¼‰ -->
  <h3>ğŸ“¸ å†™çœŸã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆOCRï¼‰</h3>
  <input id="ocrInput" type="file" accept="image/*">
  <button onclick="sendOCR()">å†™çœŸã‚’èª­ã¿å–ã‚‹</button>

  <h4>OCR çµæœ</h4>
  <pre id="ocrResult"></pre>

<script>
// ------------------------------------
// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
// ------------------------------------
async function sendMessage() {
  const userText = document.getElementById("userInput").value.trim();
  if (!userText) return;

  addMessage("ã‚ãªãŸ", userText, "msg-user");

  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      messages: [{ role: "user", content: userText }]
    })
  });

  const data = await res.json();
  addMessage("Bot", data.reply, "msg-bot");

  document.getElementById("userInput").value = "";
}

// ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
function addMessage(sender, text, css) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = css;
  div.textContent = sender + "ï¼š\n" + text + "\n";
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ------------------------------------
// éŸ³å£°èªè­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶çµ„ã¿è¾¼ã¿ï¼‰
// ------------------------------------
function startVoice() {
  const speech = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  speech.lang = "ja-JP";

  document.getElementById("voiceStatus").innerText = "ğŸ¤ éŸ³å£°èªè­˜ä¸­â€¦";

  speech.onresult = async function (e) {
    const rawText = e.results[0][0].transcript;

    // èªè­˜çµæœã‚’ clean-text API ã«é€ã‚‹
    const res = await fetch("/api/clean-text", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rawText })
    });

    const data = await res.json();
    document.getElementById("userInput").value = data.cleanedText;
    document.getElementById("voiceStatus").innerText = "âœ” éŸ³å£°å…¥åŠ›å®Œäº†";
  };

  speech.onerror = function () {
    document.getElementById("voiceStatus").innerText = "âŒ éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼";
  };

  speech.start();
}

// ------------------------------------
// OCRï¼ˆå†™çœŸ â†’ ãƒ†ã‚­ã‚¹ãƒˆï¼‰
// ------------------------------------
async function sendOCR() {
  const file = document.getElementById("ocrInput").files[0];
  if (!file) {
    alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(",")[1];

    const res = await fetch("/api/ocr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageBase64: base64 })
    });

    const data = await res.json();

    // OCRçµæœè¡¨ç¤º
    document.getElementById("ocrResult").innerText = data.ocrText;

    // OCRçµæœã‚’ userInput ã«ã‚³ãƒ”ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    document.getElementById("userInput").value = data.ocrText;
  };

  reader.readAsDataURL(file);
}

</script>

</body>
</html>
